<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Invest Mind – Painel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #f8f9fb 0%, #eef2ff 40%, #eaeaff 100%);
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <!-- Cabeçalho -->
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <div>
        <h1 id="hello" class="text-xl font-semibold text-gray-800">Bem-vindo</h1>
        <p id="account" class="text-sm text-gray-500"></p>
      </div>
      <button id="logoutBtn" class="px-4 py-2 text-sm rounded-lg border border-gray-300 hover:bg-gray-100 transition">
        Sair
      </button>
    </div>
  </header>

  <!-- Conteúdo -->
  <main class="flex-1 max-w-6xl mx-auto p-6 space-y-8">
    
    <!-- KPIs -->
    <section id="kpis" class="grid md:grid-cols-3 gap-4"></section>

    <!-- Posições + Alocação -->
    <section class="grid md:grid-cols-3 gap-6">
      <div class="md:col-span-2 bg-white rounded-2xl shadow p-6">
        <h2 class="font-semibold text-gray-700 mb-4 text-lg">Posições</h2>
        <table class="w-full text-sm">
          <thead class="text-left text-gray-500 border-b">
            <tr>
              <th class="pb-2">Ticker</th>
              <th class="pb-2">Qtd</th>
              <th class="pb-2">Preço</th>
              <th class="pb-2">PM</th>
              <th class="pb-2">PnL</th>
            </tr>
          </thead>
          <tbody id="positions" class="divide-y"></tbody>
        </table>
      </div>

      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="font-semibold text-gray-700 mb-4 text-lg">Alocação</h2>
        <canvas id="alloc" height="180"></canvas>
      </div>
    </section>

    <!-- Watchlist -->
    <section class="bg-white rounded-2xl shadow p-6">
      <h2 class="font-semibold text-gray-700 mb-4 text-lg">Watchlist</h2>
      <div id="watchlist" class="grid md:grid-cols-3 gap-4"></div>
    </section>

  </main>

  <!-- Rodapé -->
  <footer class="text-center text-gray-400 text-xs py-6">
    © 2025 Invest Mind – todos os direitos reservados
  </footer>

  <!-- Script -->
  <script>
    async function load() {
      const r = await fetch('/api/session');
      const data = await r.json();
      if (!data.authenticated) { location.href = '/'; return; }

      const name = data.user.name;
      const p = data.portfolio;

      document.getElementById('hello').innerText = `Bem-vindo, ${name}!`;
      document.getElementById('account').innerText = p.summary.accountName;

      // KPIs
      const kpis = document.getElementById('kpis');
      const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      const kpi = (label, val) =>
        `<div class="bg-white rounded-2xl shadow p-6 text-center">
          <div class="text-gray-500 text-sm">${label}</div>
          <div class="text-2xl font-semibold mt-1 text-gray-800">${val}</div>
        </div>`;
      kpis.innerHTML = kpi("Saldo", fmt(p.summary.balance))
        + kpi("PnL (Dia)", fmt(p.summary.dailyPnl))
        + kpi("PnL (Ano)", fmt(p.summary.ytdPnl));

      // Posições
      const pos = document.getElementById('positions');
      pos.innerHTML = p.positions.map(row =>
        `<tr class="hover:bg-gray-50 transition">
          <td class="py-2 font-medium">${row.ticker}</td>
          <td>${row.qty}</td>
          <td>${fmt(row.price)}</td>
          <td>${fmt(row.avg)}</td>
          <td class="${row.pnl>=0?'text-green-600':'text-red-600'} font-semibold">${fmt(row.pnl)}</td>
        </tr>`).join('');

      // Watchlist
      const wl = document.getElementById('watchlist');
      const pct = (x)=> (x>0?`+${x}`:x.toString()).replace('.',',') + '%';
      wl.innerHTML = p.watchlist.map(it =>
        `<div class="border rounded-xl p-4 hover:shadow-md transition">
          <div class="font-semibold text-gray-800">${it.ticker}</div>
          <div class="text-sm text-gray-500">Preço Atual</div>
          <div class="text-lg text-gray-800">${fmt(it.price)}</div>
          <div class="${it.chg>=0?'text-green-600':'text-red-600'} text-sm">${pct(it.chg)}</div>
        </div>`).join('');

      // Gráfico de Alocação
      const ctx = document.getElementById('alloc');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: p.allocation.map(a=>a.label),
          datasets: [{
            data: p.allocation.map(a=>a.value),
            backgroundColor: ['#6366F1', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981']
          }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    }

    // Logout
    document.getElementById('logoutBtn').onclick = async () => {
      await fetch('/api/logout', { method: 'POST' });
      location.href = '/';
    };

    load();
  </script>
</body>
</html>
